document.addEventListener('DOMContentLoaded', () => {
    const socket = io({
        transports: ['websocket'],
        reconnection: true,
        reconnectionAttempts: Infinity,
        reconnectionDelay: 1000
    });

    let currentConversationId = null;
    let currentAgent = null;

    // Socket.IO event handlers
    socket.on('connect', () => {
        console.log('Connected to Socket.IO server');
        checkAuth();
        fetchConversations();
    });

    socket.on('disconnect', () => {
        console.log('Disconnected from Socket.IO server');
        showNotification('Disconnected from server. Attempting to reconnect...', 'error');
    });

    socket.on('reconnect', (attempt) => {
        console.log(`Reconnected to Socket.IO server after ${attempt} attempts`);
        showNotification('Reconnected to server!', 'success');
        checkAuth();
        fetchConversations();
        if (currentConversationId) {
            socket.emit('join_conversation', { conversation_id: currentConversationId });
        }
    });

    socket.on('new_message', (data) => {
        console.log('New message received:', data);
        if (data.convo_id === currentConversationId) {
            appendMessage(data.message, data.sender);
        }
    });

    socket.on('refresh_conversations', (data) => {
        console.log('Refreshing conversations:', data);
        fetchConversations();
    });

    socket.on('ai_status', (data) => {
        if (data.convo_id === currentConversationId) {
            const aiToggle = document.getElementById('ai-toggle');
            aiToggle.checked = data.ai_enabled;
            showNotification(data.ai_enabled ? 'AI has been enabled for this conversation.' : 'AI has been disabled for this conversation.', 'info');
        }
    });

    socket.on('error', (data) => {
        console.error('Socket.IO error:', data);
        showNotification(data.message || 'An error occurred.', 'error');
    });

    // Authentication check
    async function checkAuth() {
        const response = await fetch('/check-auth');
        const data = await response.json();
        if (!data.is_authenticated) {
            window.location.href = '/login.html';
        } else {
            currentAgent = data.agent;
            document.getElementById('agent-name').textContent = `Agent: ${currentAgent}`;
        }
    }

    // Fetch conversations
    async function fetchConversations() {
        try {
            const response = await fetch('/conversations');
            const data = await response.json();
            const conversationList = document.getElementById('conversation-list');
            conversationList.innerHTML = '';

            const visibleConversations = data.filter(convo => convo.channel !== 'test');
            visibleConversations.forEach(convo => {
                const li = document.createElement('li');
                li.className = 'p-2 hover:bg-gray-200 cursor-pointer';
                li.textContent = convo.display_name || convo.username;
                if (convo.assigned_agent) {
                    li.textContent += ` (Assigned to ${convo.assigned_agent})`;
                }
                li.addEventListener('click', () => loadConversation(convo.id));
                conversationList.appendChild(li);
            });
        } catch (error) {
            console.error('Error fetching conversations:', error);
            showNotification('Failed to load conversations.', 'error');
        }
    }

    // Load a specific conversation
    async function loadConversation(convoId) {
        if (currentConversationId) {
            socket.emit('leave_conversation', { conversation_id: currentConversationId });
        }
        currentConversationId = convoId;
        socket.emit('join_conversation', { conversation_id: convoId });

        try {
            const response = await fetch(`/messages?conversation_id=${convoId}`);
            const data = await response.json();
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';

            document.getElementById('conversation-title').textContent = `Conversation with ${data.username || data.chat_id || 'Unknown'}`;
            data.messages.forEach(msg => {
                appendMessage(msg.message, msg.sender);
            });

            const assignButton = document.getElementById('assign-button');
            assignButton.onclick = () => assignAgent(convoId);

            const handBackButton = document.getElementById('hand-back-button');
            handBackButton.onclick = () => handBackToAI(convoId);
        } catch (error) {
            console.error('Error loading conversation:', error);
            showNotification('Failed to load conversation.', 'error');
        }
    }

    // Append a message to the chat box
    function appendMessage(message, sender) {
        const chatBox = document.getElementById('chat-box');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender === 'user' ? 'user-message' : 'ai-message'}`;
        messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Send a message
    document.getElementById('send-button').addEventListener('click', sendMessage);
    document.getElementById('message-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function sendMessage() {
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        if (message && currentConversationId) {
            socket.emit('agent_message', {
                conversation_id: currentConversationId,
                message: message,
                channel: 'dashboard'
            });
            input.value = '';
        }
    }

    // Assign agent to conversation
    async function assignAgent(convoId) {
        try {
            const response = await fetch('/assign-agent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ conversation_id: convoId, agent: currentAgent })
            });
            const data = await response.json();
            if (data.status === 'success') {
                showNotification('Assigned to conversation.', 'success');
                fetchConversations();
            } else {
                showNotification('Failed to assign agent.', 'error');
            }
        } catch (error) {
            console.error('Error assigning agent:', error);
            showNotification('Failed to assign agent.', 'error');
        }
    }

    // Hand back to AI
    function handBackToAI(convoId) {
        socket.emit('hand_back_to_ai', { conversation_id: convoId });
    }

    // Show notification
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    // Logout
    document.getElementById('logout-button').addEventListener('click', async () => {
        await fetch('/logout', { method: 'POST' });
        window.location.href = '/login.html';
    });
});
